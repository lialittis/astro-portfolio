const N=(t,e)=>t===e,h={equals:N};let y=C;const a=1,p=2,T={};var i=null;let d=null,V=null,l=null,o=null,f=null,S=0;function q(t,e){e=e?Object.assign({},h,e):h;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},r=n=>(typeof n=="function"&&(n=n(s.value)),k(s,n));return[O.bind(s),r]}function I(t,e,s){y=F;const r=x(t,e,!1,a);r.user=!0,f?f.push(r):E(r)}function A(t,e,s){s=s?Object.assign({},h,s):h;const r=x(t,e,!0,0);return r.observers=null,r.observerSlots=null,r.comparator=s.equals||void 0,E(r),O.bind(r)}function w(t){if(l===null)return t();const e=l;l=null;try{return t()}finally{l=e}}function G(t){I(()=>w(t))}function P(t){return i===null||(i.cleanups===null?i.cleanups=[t]:i.cleanups.push(t)),t}function O(){if(this.sources&&this.state)if(this.state===a)E(this);else{const t=o;o=null,m(()=>g(this)),o=t}if(l){const t=this.observers?this.observers.length:0;l.sources?(l.sources.push(this),l.sourceSlots.push(t)):(l.sources=[this],l.sourceSlots=[t]),this.observers?(this.observers.push(l),this.observerSlots.push(l.sources.length-1)):(this.observers=[l],this.observerSlots=[l.sources.length-1])}return this.value}function k(t,e,s){let r=t.value;return(!t.comparator||!t.comparator(r,e))&&(t.value=e,t.observers&&t.observers.length&&m(()=>{for(let n=0;n<t.observers.length;n+=1){const u=t.observers[n],c=d&&d.running;c&&d.disposed.has(u),(c?!u.tState:!u.state)&&(u.pure?o.push(u):f.push(u),u.observers&&U(u)),c||(u.state=a)}if(o.length>1e6)throw o=[],new Error})),e}function E(t){if(!t.fn)return;v(t);const e=S;L(t,t.value,e)}function L(t,e,s){let r;const n=i,u=l;l=i=t;try{r=t.fn(e)}catch(c){return t.pure&&(t.state=a,t.owned&&t.owned.forEach(v),t.owned=null),t.updatedAt=s+1,D(c)}finally{l=u,i=n}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?k(t,r):t.value=r,t.updatedAt=s)}function x(t,e,s,r=a,n){const u={fn:t,state:r,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:i,context:i?i.context:null,pure:s};return i===null||i!==T&&(i.owned?i.owned.push(u):i.owned=[u]),u}function b(t){if(t.state===0)return;if(t.state===p)return g(t);if(t.suspense&&w(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<S);)t.state&&e.push(t);for(let s=e.length-1;s>=0;s--)if(t=e[s],t.state===a)E(t);else if(t.state===p){const r=o;o=null,m(()=>g(t,e[0])),o=r}}function m(t,e){if(o)return t();let s=!1;o=[],f?s=!0:f=[],S++;try{const r=t();return j(s),r}catch(r){s||(f=null),o=null,D(r)}}function j(t){if(o&&(C(o),o=null),t)return;const e=f;f=null,e.length&&m(()=>y(e))}function C(t){for(let e=0;e<t.length;e++)b(t[e])}function F(t){let e,s=0;for(e=0;e<t.length;e++){const r=t[e];r.user?t[s++]=r:b(r)}for(e=0;e<s;e++)b(t[e])}function g(t,e){t.state=0;for(let s=0;s<t.sources.length;s+=1){const r=t.sources[s];if(r.sources){const n=r.state;n===a?r!==e&&(!r.updatedAt||r.updatedAt<S)&&b(r):n===p&&g(r,e)}}}function U(t){for(let e=0;e<t.observers.length;e+=1){const s=t.observers[e];s.state||(s.state=p,s.pure?o.push(s):f.push(s),s.observers&&U(s))}}function v(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),r=t.sourceSlots.pop(),n=s.observers;if(n&&n.length){const u=n.pop(),c=s.observerSlots.pop();r<n.length&&(u.sourceSlots[c]=r,n[r]=u,s.observerSlots[r]=c)}}if(t.tOwned){for(e=t.tOwned.length-1;e>=0;e--)v(t.tOwned[e]);delete t.tOwned}if(t.owned){for(e=t.owned.length-1;e>=0;e--)v(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function M(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function D(t,e=i){throw M(t)}const _=t=>`Stale read from <${t}>.`;function Q(t){const e=t.keyed,s=A(()=>t.when,void 0,void 0),r=e?s:A(s,void 0,{equals:(n,u)=>!n==!u});return A(()=>{const n=r();if(n){const u=t.children;return typeof u=="function"&&u.length>0?w(()=>u(e?n:()=>{if(!w(r))throw _("Show");return s()})):u}return t.fallback},void 0,void 0)}export{Q as S,P as a,q as c,G as o};
