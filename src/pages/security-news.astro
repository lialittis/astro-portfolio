---
import SimpleLayout from '../layouts/SimpleLayout.astro'
import NavBar from '../components/NavBar.astro'
import { getCollection } from 'astro:content'

const title = 'Security News'
const description =
	'Latest updates and insights on security trends and vulnerabilities.'

const allPosts = await getCollection('updates')

const securityPosts = allPosts
	.filter(
		(post: { data: { tags?: string[] } }) =>
			Array.isArray(post.data.tags) && post.data.tags.includes('security')
	)
	.sort(
		(a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
	)

// Pre-render markdown content
const renderedPosts = await Promise.all(
	securityPosts.map(
		async (post: {
			render: () => PromiseLike<{ Content: any }> | { Content: any }
			data: { title: any; date: any }
		}) => {
			const { Content } = await post.render()
			return {
				title: post.data.title,
				date: post.data.date,
				Content
			}
		}
	)
)

// Only show the 3 latest posts
const latestPosts = renderedPosts.slice(0, 3)
const hasMorePosts = renderedPosts.length > 3
---

<SimpleLayout title={title} description={description}>
	<NavBar />

	<div class='w-screen min-h-screen dotted-bg'>
		<section
			class='pt-20 flex flex-col items-center text-white text-center gap-4'
		>
			<h1 class='text-4xl md:text-5xl xl:text-6xl font-bold'>
				Security News <br />
				<span class='font-normal'>Latest Updates</span>
			</h1>
			<p class='text-lg text-secondary-200 max-w-xl'>
				Stay informed with the latest security trends and insights...
			</p>
		</section>

		<section class='mt-16 flex flex-col items-center gap-6'>
			<h2 class='text-2xl md:text-3xl font-bold text-white'>Latest Articles</h2>
			<p class='text-lg text-secondary-200 text-white mb-4'>
				Explore the most recent articles on security topics.
			</p>

			<div class='flex flex-col gap-8 max-w-7xl w-full px-4'>
				{latestPosts.map(({ title, date, Content }, idx) => (
					<article
						class={`security-card bg-white text-black rounded-lg shadow-lg overflow-hidden transition-all duration-500 cursor-pointer ${idx === 0 ? 'expanded' : 'collapsed'}`}
						data-index={idx}
						tabindex="0"
					>
						<div class="p-8">
							<h3 class="text-2xl font-bold mb-2">
								<span class="mr-3 text-secondary-700">{idx + 1}.</span>
								{title}
							</h3>
							<p class="text-base text-gray-500 mb-4">{date}</p>
						</div>
						<div class="content prose max-w-none text-left px-8 pb-8 transition-all duration-500 overflow-y-auto">
							<Content />
						</div>
					</article>
				))}
				{hasMorePosts ? (
					<a
						href='/security-news/archive'
						class='mt-4 self-center px-6 py-2 rounded-lg bg-secondary-700 text-white font-semibold shadow hover:bg-secondary-800 transition'
					>
						View All Security News
					</a>
				) : null}
			</div>
		</section>

		<section
			class='mt-16 flex flex-col items-center gap-4 text-white text-center'
		>
			<h2 class='text-2xl md:text-3xl font-bold'>Upcoming Events</h2>
			<p class='text-lg text-secondary-200'>
				Check out the upcoming security conferences and webinars.
			</p>
		</section>

		<section
			class='mt-16 mb-20 flex flex-col items-center gap-4 text-white text-center'
		>
			<h2 class='text-2xl md:text-3xl font-bold'>Security Tools</h2>
			<p class='text-lg text-secondary-200'>
				Discover the latest tools and resources for enhancing security.
			</p>
		</section>
	</div>
</SimpleLayout>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const cards = document.querySelectorAll('.security-card');
		
		cards.forEach((card, index) => {
			card.addEventListener('click', () => {
				// Collapse all cards
				cards.forEach(c => {
					c.classList.remove('expanded');
					c.classList.add('collapsed');
				});
				
				// Expand clicked card
				card.classList.remove('collapsed');
				card.classList.add('expanded');
			});
		});
	});
</script>

<style>
	.security-card.collapsed {
		max-height: 140px;
	}
	
	.security-card.expanded {
		max-height: 800px;
	}
	
	.security-card.collapsed .content {
		opacity: 0;
		max-height: 0;
		padding-bottom: 0;
	}
	
	.security-card.expanded .content {
		opacity: 1;
		max-height: 600px;
		padding-bottom: 2rem;
	}
	
	.security-card:hover {
		box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
		transform: translateY(-2px);
	}
</style>
